<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Serif JP', sans-serif; overscroll-behavior: none; }
        .rpg-box { border: 2px solid #4a5568; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .rpg-button { background-color: #2d3748; border: 1px solid #4a5568; transition: all 0.2s ease-in-out; }
        .rpg-button:hover:not(:disabled) { background-color: #4a5568; border-color: #718096; transform: translateY(-2px); }
        .rpg-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .screen { display: none; animation: fadeIn 0.5s; }
        .active-screen { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #718096; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        .party-member-card.active { background-color: #4a5568; border-color: #a0aec0; }
        #notification-popup { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, transform 0.3s; }
        #notification-popup.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
        #notification-popup.error { background-color: #c53030; }
        #notification-popup.success { background-color: #2f855a; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- é€šçŸ¥ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="notification-popup"></div>

    <!-- åå‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="name-change-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full rpg-box">
            <h2 class="text-2xl font-bold mb-4 text-yellow-400">åå‰ã®å¤‰æ›´</h2>
            <p class="mb-4">æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <input id="name-change-input" type="text" maxlength="10" class="w-full bg-gray-900 text-white p-2 rounded border border-gray-600" placeholder="10æ–‡å­—ä»¥å†…">
            <div class="flex justify-end gap-4 mt-6">
                <button id="name-change-cancel-btn" class="rpg-button px-6 py-2 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="name-change-confirm-btn" class="bg-green-700 hover:bg-green-600 text-white px-6 py-2 rounded-lg">æ±ºå®š</button>
            </div>
        </div>
    </div>
    
    <!-- å£²å´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="sell-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full rpg-box">
            <h2 id="sell-item-name" class="text-2xl font-bold mb-2 text-yellow-400"></h2>
            <p class="mb-4">å£²å´ã™ã‚‹æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
            <div class="flex items-center justify-center gap-4 my-6">
                <button id="sell-qty-minus" class="rpg-button w-10 h-10 text-2xl rounded-full">-</button>
                <input id="sell-qty-input" type="number" value="1" min="1" class="w-20 h-12 text-center text-2xl bg-gray-900 border border-gray-600 rounded">
                <button id="sell-qty-plus" class="rpg-button w-10 h-10 text-2xl rounded-full">+</button>
            </div>
            <div class="text-center text-xl mb-6">
                <p>å£²å´ä¾¡æ ¼: <span id="sell-total-price" class="font-bold text-yellow-400"></span> G</p>
            </div>
            <div class="flex justify-end gap-4">
                <button id="sell-cancel-btn" class="rpg-button px-6 py-2 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="sell-confirm-btn" class="bg-red-700 hover:bg-red-600 text-white px-6 py-2 rounded-lg">å£²å´ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- è£…å‚™å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="equipment-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 items-center justify-center hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-lg w-full rpg-box">
            <h2 id="equipment-slot-name" class="text-2xl font-bold mb-4 text-yellow-400"></h2>
            <div id="equipment-list" class="max-h-80 overflow-y-auto space-y-2 pr-2"></div>
            <div class="text-right mt-6">
                <button id="equipment-cancel-btn" class="rpg-button px-6 py-2 rounded-lg">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- è³¼å…¥ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="purchase-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full rpg-box">
            <h2 id="purchase-item-name" class="text-2xl font-bold mb-2 text-yellow-400"></h2>
            <p id="purchase-item-desc" class="mb-4 text-gray-400"></p>
            <div class="flex items-center justify-center gap-4 my-6">
                <button id="purchase-qty-minus" class="rpg-button w-10 h-10 text-2xl rounded-full">-</button>
                <input id="purchase-qty-input" type="number" value="1" min="1" max="99" class="w-20 h-12 text-center text-2xl bg-gray-900 border border-gray-600 rounded">
                <button id="purchase-qty-plus" class="rpg-button w-10 h-10 text-2xl rounded-full">+</button>
            </div>
            <div class="text-center text-xl mb-6">
                <p>åˆè¨ˆé‡‘é¡: <span id="purchase-total-cost" class="font-bold text-yellow-400"></span> G</p>
                <p class="text-sm">æ‰€æŒé‡‘: <span id="purchase-player-gold" class="text-gray-400"></span> G</p>
                <p id="purchase-warning" class="text-red-500 text-sm min-h-[1.25rem] mt-1"></p>
            </div>
            <div class="flex justify-end gap-4">
                <button id="purchase-cancel-btn" class="rpg-button px-6 py-2 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="purchase-confirm-btn" class="bg-green-700 hover:bg-green-600 text-white px-6 py-2 rounded-lg">è³¼å…¥ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full rpg-box">
            <h2 id="confirmation-title" class="text-xl font-bold mb-4 text-yellow-400">ç¢ºèª</h2>
            <p id="confirmation-message" class="mb-6">æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="rpg-button px-6 py-2 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirm-ok-btn" class="bg-red-700 hover:bg-red-600 text-white px-6 py-2 rounded-lg">å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <!-- åˆå›èµ·å‹•ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="first-time-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-lg w-full rpg-box">
            <div id="new-game-selection">
                <h2 class="text-2xl font-bold mb-4 text-yellow-400">ç‹å›½ã‚ˆã‚Š</h2>
                <p class="mb-4">ã‚ˆã†ã“ãã€æ–°ãŸãªã‚‹æ¢ç´¢è€…ã‚ˆã€‚ã¾ãšã¯å›ã®åã‚’æ•™ãˆã¦ãã‚Œã€‚</p>
                <input id="player-name-input" type="text" maxlength="10" class="w-full bg-gray-900 text-white p-2 rounded border border-gray-600 mb-6" placeholder="ã‚ãªãŸã®åå‰ (æœªå…¥åŠ›ã§ã€Œå†’é™ºè€…ã€)">
                <p class="mb-4 font-semibold">æ¬¡ã«ã€æ±ã®è·æ¥­ã‚’é¸ã³ãŸã¾ãˆï¼š</p>
                <div class="flex gap-4 mb-6">
                    <button id="select-swordsman" class="rpg-button flex-1 p-4 rounded-lg text-lg">å‰£å£«</button>
                    <button id="select-mage" class="rpg-button flex-1 p-4 rounded-lg text-lg">é­”å°å£«</button>
                </div>
                <div class="text-center">
                    <button id="show-import-btn" class="text-cyan-400 hover:underline">ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ</button>
                </div>
            </div>
            <div id="import-game-section" class="hidden">
                 <h2 class="text-2xl font-bold mb-4 text-yellow-400">ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
                 <p class="mb-4">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä»¥ä¸‹ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
                 <textarea id="import-data-textarea" class="w-full h-40 bg-gray-900 text-white p-2 rounded border border-gray-600"></textarea>
                 <div class="flex justify-between items-center mt-4">
                    <button id="back-to-new-game-btn" class="text-cyan-400 hover:underline">æˆ»ã‚‹</button>
                    <div>
                        <span id="import-error" class="text-red-400 mr-4"></span>
                        <button id="import-data-btn" class="rpg-button px-6 py-2 rounded-lg">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    </div>
                 </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="container mx-auto p-4 max-w-4xl">
        
        <!-- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
        <div id="main-menu-screen" class="screen active-screen">
            <div class="bg-gray-800 p-6 rounded-lg rpg-box">
                <h1 class="text-3xl font-bold text-center mb-6 border-b-2 border-gray-600 pb-3">ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h1>
                <div id="status-display" class="mb-6 text-lg grid grid-cols-2 gap-x-4 gap-y-2">
                    <div>åå‰: <span id="player-name" class="font-semibold text-cyan-400"></span></div>
                    <div>ãƒ¬ãƒ™ãƒ«: <span id="player-level" class="font-semibold text-green-400"></span></div>
                    <div>è·æ¥­: <span id="player-class" class="font-semibold text-cyan-400"></span></div>
                    <div>æ‰€æŒé‡‘: <span id="player-gold" class="font-semibold text-yellow-400"></span> G</div>
                </div>
                <nav class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button data-screen="kingdom" class="p-4 rounded rpg-button text-lg">ç‹å›½</button>
                    <button data-screen="explore" class="p-4 rounded rpg-button text-lg">æ¢ç´¢</button>
                    <button data-screen="party" class="p-4 rounded rpg-button text-lg">ãƒ‘ãƒ¼ãƒ†ã‚£</button>
                    <button data-screen="items" class="p-4 rounded rpg-button text-lg">ã‚¢ã‚¤ãƒ†ãƒ </button>
                    <button data-screen="options" class="p-4 rounded rpg-button text-lg">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</button>
                </nav>
            </div>
        </div>

        <!-- ç‹å›½ -->
        <div id="kingdom-screen" class="screen">
            <div class="bg-gray-800 p-6 rounded-lg rpg-box">
                <button data-screen="main-menu" class="rpg-button px-4 py-1 rounded mb-4">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</button>
                <h2 class="text-2xl font-bold mb-4 border-b-2 border-gray-600 pb-2">ç‹å›½</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <button data-screen="guild" class="p-4 rounded rpg-button text-lg">æ¢ç´¢è€…å”ä¼š</button>
                    <button data-screen="blacksmith" class="p-4 rounded rpg-button text-lg">é›å†¶å±‹</button>
                    <button data-screen="general-store" class="p-4 rounded rpg-button text-lg">é›‘è²¨å±‹</button>
                    <button data-screen="ranch" class="p-4 rounded rpg-button text-lg">ç‰§å ´</button>
                </div>
            </div>
        </div>

        <!-- æ¢ç´¢è€…å”ä¼š -->
        <div id="guild-screen" class="screen">
            <div class="bg-gray-800 p-6 rounded-lg rpg-box">
                <button data-screen="kingdom" class="rpg-button px-4 py-1 rounded mb-4">â† ç‹å›½ã¸æˆ»ã‚‹</button>
                <h2 class="text-2xl font-bold mb-4">æ¢ç´¢è€…å”ä¼š</h2>
                <div class="flex gap-2 mb-4">
                    <button class="rpg-button px-4 py-2 rounded-t-lg" onclick="showTab('guild-tab-1', this)">æ¢ç´¢ã®å¿ƒå¾—</button>
                    <button class="rpg-button px-4 py-2 rounded-t-lg opacity-60" onclick="showTab('guild-tab-2', this)">æ¢ç´¢çŠ¶æ³</button>
                </div>
                <div id="guild-tab-1" class="guild-tab p-4 bg-gray-900 rounded-b-lg rounded-r-lg">
                    <h3 class="text-xl font-semibold mb-2 text-yellow-300">ã‚ˆã†ã€æ–°äººï¼ä¿ºãŒæ¢ç´¢ã®ã‚¤ãƒ­ãƒã‚’æ•™ãˆã¦ã‚„ã‚‹ã€‚</h3>
                    <div class="space-y-4">
                        <div><h4 class="text-lg font-bold">æ¢ç´¢ã«ã¤ã„ã¦</h4><p>ã€Œæ¢ç´¢ã€ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é¸ã‚“ã§å†’é™ºã«å‡ºã‚‹ã‚“ã ã€‚ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’å€’ã—ã¦çµŒé¨“å€¤ã‚„ç´ æã€é‡‘ã‚’æ‰‹ã«å…¥ã‚Œã‚ã€‚ãƒ¬ãƒ™ãƒ«ãŒä¸ŠãŒã‚Œã°ã€ã‚‚ã£ã¨å¼·ããªã‚Œã‚‹ãœã€‚</p></div>
                        <div><h4 class="text-lg font-bold">è£…å‚™ã®é‡è¦æ€§</h4><p>ã€Œé›å†¶å±‹ã€ã§æ–°ã—ã„è£…å‚™ã‚’è²·ã£ãŸã‚Šã€ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®ç´ æã§ç‰¹åˆ¥ãªè£…å‚™ã‚’ä½œã£ãŸã‚Šã§ãã‚‹ã€‚è‰¯ã„è£…å‚™ã¯ã‚ã‚“ãŸã®å‘½ã‚’å®ˆã‚‹ã€‚é‡‘ã‚„ç´ æã‚’æƒœã—ã‚€ãªã‚ˆã€‚</p></div>
                        <div><h4 class="text-lg font-bold">ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ´»ç”¨ã—ã‚</h4><p>ã€Œé›‘è²¨å±‹ã€ã§ã¯å›å¾©è–¬ãªã‚“ã‹ã®ä¾¿åˆ©ãªã‚‚ã®ãŒæ‰‹ã«å…¥ã‚‹ã€‚æ¢ç´¢ã«è¡Œãå‰ã«ã¯æº–å‚™ã‚’ä¸‡ç«¯ã«ã—ã¦ãŠã‘ã€‚æŒã£ã¦ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã¯ã€Œã‚¢ã‚¤ãƒ†ãƒ ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ç¢ºèªã§ãã‚‹ãã€‚</p></div>
                         <div><h4 class="text-lg font-bold">ä»²é–“ã¨å”åŠ›ã </h4><p>å†’é™ºã¯ä¸€äººã˜ã‚ƒãªã„ã€‚ã€Œãƒ‘ãƒ¼ãƒ†ã‚£ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ä»²é–“ã®æ§˜å­ã‚’ç¢ºèªã—ãŸã‚Šã€è£…å‚™ã‚’å¤‰ãˆã¦ã‚„ã£ãŸã‚Šã§ãã‚‹ã€‚é ¼ã‚Šã«ãªã‚‹ä»²é–“ãŒã„ã‚Œã°ç™¾äººåŠ›ã ã€‚</p></div>
                    </div>
                </div>
                <div id="guild-tab-2" class="guild-tab hidden p-4 bg-gray-900 rounded-b-lg rounded-r-lg">
                    <h3 class="text-xl font-semibold mb-2">å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¢ç´¢çŠ¶æ³</h3>
                    <div id="field-progress-container" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- é›å†¶å±‹ -->
        <div id="blacksmith-screen" class="screen">
            <div class="bg-gray-800 p-6 rounded-lg rpg-box">
                <div class="flex justify-between items-center mb-4">
                    <button data-screen="kingdom" class="rpg-button px-4 py-1 rounded">â† ç‹å›½ã¸æˆ»ã‚‹</button>
                    <div class="text-lg">æ‰€æŒé‡‘: <span id="blacksmith-gold" class="font-semibold text-yellow-400"></span> G</div>
                </div>
                <h2 class="text-2xl font-bold mb-4">é›å†¶å±‹</h2>
                <p class="italic bg-gray-900 p-3 rounded-md mb-4">ã€Œã¸ã„ã€ã„ã‚‰ã£ã—ã‚ƒã„ï¼ã€€ã‚¦ãƒã®æ­¦å…·ã¯ä¸€ç´šå“ã ãœã€‚è¦‹ã¦ã„ããªï¼ã€</p>
                <div class="flex gap-2 mb-4">
                    <button class="rpg-button px-4 py-2 rounded-t-lg" onclick="showTab('blacksmith-tab-1', this)">è³¼å…¥</button>
                    <button class="rpg-button px-4 py-2 rounded-t-lg opacity-60" onclick="showTab('blacksmith-tab-2', this)">ä½œæˆ</button>
                </div>
                <div id="blacksmith-tab-1" class="blacksmith-tab p-4 bg-gray-900 rounded-b-lg rounded-r-lg">
                    <h3 class="text-xl font-semibold mb-2">è³¼å…¥å¯èƒ½ãªè£…å‚™</h3>
                    <div id="blacksmith-purchase-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
                <div id="blacksmith-tab-2" class="blacksmith-tab hidden p-4 bg-gray-900 rounded-b-lg rounded-r-lg">
                    <h3 class="text-xl font-semibold mb-2">ä½œæˆå¯èƒ½ãªè£…å‚™</h3>
                    <div id="blacksmith-craft-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- é›‘è²¨å±‹ -->
        <div id="general-store-screen" class="screen">
            <div class="bg-gray-800 p-6 rounded-lg rpg-box">
                <div class="flex justify-between items-center mb-4">
                    <button data-screen="kingdom" class="rpg-button px-4 py-1 rounded">â† ç‹å›½ã¸æˆ»ã‚‹</button>
                    <div class="text-lg">æ‰€æŒé‡‘: <span id="general-store-gold" class="font-semibold text-yellow-400"></span> G</div>
                </div>
                <h2 class="text-2xl font-bold mb-4">é›‘è²¨å±‹</h2>
                <p class="italic bg-gray-900 p-3 rounded-md mb-4">ã€Œã‚ã‚‰ã€ã„ã‚‰ã£ã—ã‚ƒã„ã€‚å†’é™ºã«å½¹ç«‹ã¤ã‚‚ã®ã‚’æƒãˆã¦ã‚‹ã‚ã‚ˆã€‚ã‚†ã£ãã‚Šè¦‹ã¦ã„ã£ã¦ã­ã€‚ã€</p>
                <div class="flex gap-2 mb-4">
                    <button class="rpg-button px-4 py-2 rounded-t-lg" onclick="showTab('store-tab-1', this)">è³¼å…¥</button>
                    <button class="rpg-button px-4 py-2 rounded-t-lg opacity-60" onclick="showTab('store-tab-2', this)">å£²å´</button>
                </div>
                <div id="store-tab-1" class="store-tab p-4 bg-gray-900 rounded-b-lg rounded-r-lg">
                    <h3 class="text-xl font-semibold mb-2">å•†å“ãƒªã‚¹ãƒˆ</h3>
                    <div id="store-purchase-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
                <div id="store-tab-2" class="store-tab hidden p-4 bg-gray-900 rounded-b-lg rounded-r-lg">
                    <h3 class="text-xl font-semibold mb-2">æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ ã‚’å£²å´</h3>
                    <div id="store-sell-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>
        
        <!-- ç‰§å ´ -->
        <div id="ranch-screen" class="screen">
            <div class="bg-gray-800 p-6 rounded-lg rpg-box">
                <button data-screen="kingdom" class="rpg-button px-4 py-1 rounded mb-4">â† ç‹å›½ã¸æˆ»ã‚‹</button>
                <h2 class="text-2xl font-bold mb-4">ç‰§å ´</h2>
                <p class="italic bg-gray-900 p-3 rounded-md mb-4">ã€Œã‚„ã‚ã€ã‚ˆãæ¥ãŸã­ã€‚ã“ã“ã¯å‹•ç‰©ãŸã¡ã¨ã®ã©ã‹ãªæ™‚é–“ã‚’éã”ã›ã‚‹å ´æ‰€ã•ã€‚ä»Šã¯ã¾ã æº–å‚™ä¸­ã ã‘ã©ã€æ¥½ã—ã¿ã«ã—ã¦ã¦ãã‚Œã‚ˆãªï¼ã€</p>
                <p class="text-center text-2xl mt-12 text-yellow-400">ğŸš§ ç¾åœ¨å®Ÿè£…ä¸­ã§ã™ ğŸš§</p>
            </div>
        </div>

        <!-- æ¢ç´¢ -->
        <div id="explore-screen" class="screen">
            <div class="bg-gray-800 p-6 rounded-lg rpg-box">
                <button data-screen="main-menu" class="rpg-button px-4 py-1 rounded mb-4">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</button>
                <h2 class="text-2xl font-bold mb-4">æ¢ç´¢</h2>
                <div id="explore-field-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <!-- ãƒ‘ãƒ¼ãƒ†ã‚£ -->
        <div id="party-screen" class="screen">
            <div class="bg-gray-800 p-6 rounded-lg rpg-box">
                <button data-screen="main-menu" class="rpg-button px-4 py-1 rounded mb-4">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</button>
                <h2 class="text-2xl font-bold mb-4">ãƒ‘ãƒ¼ãƒ†ã‚£ç·¨æˆ</h2>
                <div class="flex flex-col md:flex-row gap-4">
                    <div id="party-member-list" class="flex md:flex-col gap-2"></div>
                    <div id="party-member-details" class="flex-grow bg-gray-900 p-4 rounded-lg"></div>
                </div>
            </div>
        </div>

        <!-- ã‚¢ã‚¤ãƒ†ãƒ  -->
        <div id="items-screen" class="screen">
            <div class="bg-gray-800 p-6 rounded-lg rpg-box">
                <button data-screen="main-menu" class="rpg-button px-4 py-1 rounded mb-4">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</button>
                <h2 class="text-2xl font-bold mb-4">æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ </h2>
                <div class="flex gap-2 mb-4">
                    <button class="rpg-button px-4 py-2 rounded-t-lg" onclick="renderItemsScreen('equipment', this)">è£…å‚™å“</button>
                    <button class="rpg-button px-4 py-2 rounded-t-lg opacity-60" onclick="renderItemsScreen('other', this)">æ¶ˆè€—å“/ç´ æ</button>
                </div>
                <div id="inventory-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2 bg-gray-900 p-4 rounded-b-lg rounded-r-lg"></div>
            </div>
        </div>

        <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
        <div id="options-screen" class="screen">
            <div class="bg-gray-800 p-6 rounded-lg rpg-box">
                <button data-screen="main-menu" class="rpg-button px-4 py-1 rounded mb-4">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</button>
                <h2 class="text-2xl font-bold mb-4">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <button data-screen="monster-book" class="p-4 rounded rpg-button text-lg">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å›³é‘‘</button>
                    <button data-screen="export-data" class="p-4 rounded rpg-button text-lg">ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button id="name-change-btn" class="p-4 rounded rpg-button text-lg">åå‰ã®å¤‰æ›´</button>
                    <button id="reset-data-btn" class="p-4 rounded bg-red-800 hover:bg-red-700 text-lg">ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>

        <!-- ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å›³é‘‘ -->
        <div id="monster-book-screen" class="screen">
            <div class="bg-gray-800 p-6 rounded-lg rpg-box">
                <button data-screen="options" class="rpg-button px-4 py-1 rounded mb-4">â† ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¸æˆ»ã‚‹</button>
                <h2 class="text-2xl font-bold mb-4">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å›³é‘‘</h2>
                <div id="monster-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2"></div>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
        <div id="export-data-screen" class="screen">
            <div class="bg-gray-800 p-6 rounded-lg rpg-box">
                <button data-screen="options" class="rpg-button px-4 py-1 rounded mb-4">â† ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¸æˆ»ã‚‹</button>
                <h2 class="text-2xl font-bold mb-4">ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
                <p class="mb-4">ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€åˆ¥ã®å ´æ‰€ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹éš›ã«ä½¿ç”¨ã—ã¾ã™ã€‚</p>
                <textarea id="export-data-textarea" readonly class="w-full h-64 bg-gray-900 text-white p-2 rounded border border-gray-600"></textarea>
                <button id="copy-data-button" class="rpg-button px-6 py-2 rounded mt-4">ã‚³ãƒ”ãƒ¼</button>
                <span id="copy-feedback" class="ml-4 text-green-400 opacity-0 transition-opacity">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</span>
            </div>
        </div>
    </div>

<script>
// =================================================================================
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
// =================================================================================
const DB = {
    items: {
        'weapon001': { name: 'éŠ…ã®å‰£', type: 'weapon', price: 120, sellPrice: 60, description: 'ã‚ã‚Šãµã‚ŒãŸéŠ…è£½ã®å‰£ã€‚', stats: { St: 5 } },
        'weapon002': { name: 'é‰„ã®å‰£', type: 'weapon', price: 500, sellPrice: 250, description: 'éŠ…ã®å‰£ã‚ˆã‚Šä¸ˆå¤«ã§åˆ‡ã‚Œå‘³ãŒã„ã„ã€‚', stats: { St: 12 } },
        'weapon101': { name: 'åˆå¿ƒè€…ã®æ–', type: 'weapon', price: 100, sellPrice: 50, description: 'é­”åŠ›ã®è¾¼ã‚ã‚‰ã‚ŒãŸæ¨«ã®æ–ã€‚', stats: { In: 6 } },
        'head001': { name: 'çš®ã®å¸½å­', type: 'head', price: 60, sellPrice: 30, description: 'ç°¡å˜ãªçš®ã®å¸½å­ã€‚', stats: { Pa: 2 } },
        'body001': { name: 'çš®ã®æœ', type: 'body', price: 80, sellPrice: 40, description: 'å‹•ç‰©ã®çš®ã§ä½œã‚‰ã‚ŒãŸç°¡å˜ãªæœã€‚', stats: { Pa: 4 } },
        'legs001': { name: 'çš®ã®ã‚ºãƒœãƒ³', type: 'legs', price: 70, sellPrice: 35, description: 'ç°¡å˜ãªçš®ã®ã‚ºãƒœãƒ³ã€‚', stats: { Pa: 3 } },
        'accessory001': { name: 'åŠ›ã®æŒ‡è¼ª', type: 'accessory', price: 1000, sellPrice: 500, description: 'ç­‹åŠ›ãŒå°‘ã—ä¸Šæ˜‡ã™ã‚‹æŒ‡è¼ªã€‚', stats: { St: 3 } },
        'item001': { name: 'è–¬è‰', type: 'consumable', price: 20, sellPrice: 10, description: 'HPã‚’å°‘ã—å›å¾©ã™ã‚‹ã€‚' },
        'item002': { name: 'é­”åŠ›æ°´', type: 'consumable', price: 50, sellPrice: 25, description: 'MPã‚’å°‘ã—å›å¾©ã™ã‚‹ã€‚' },
        'material001': { name: 'ãƒ¯ãƒ¼ãƒ ã®ç²˜æ¶²', type: 'material', sellPrice: 5, description: 'ãƒ¯ãƒ¼ãƒ ã‹ã‚‰æ¡ã‚Œã‚‹ãƒãƒãƒãƒã—ãŸæ¶²ä½“ã€‚' },
        'material002': { name: 'ã‚´ãƒ–ãƒªãƒ³ã®æ£æ£’', type: 'material', sellPrice: 12, description: 'ã‚´ãƒ–ãƒªãƒ³ãŒä½¿ã£ã¦ã„ãŸç²—æœ«ãªæ£æ£’ã€‚' },
    },
    monsters: {'worm':{no:1,name:'ãƒ¯ãƒ¼ãƒ ',race:'èŸ²æ—',habitat:'å¹³åŸã€æ´çªŸ',story:'åœŸã®ä¸­ã«ç”Ÿæ¯ã™ã‚‹å¤§å‹ã®ãƒŸãƒŸã‚ºã®ã‚ˆã†ãªãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã€‚ç‰¹ã«æ¯’ã¯ãªã„ãŒã€ãã®ç²˜æ¶²ã¯æ§˜ã€…ãªè–¬å“ã®ææ–™ã«ãªã‚‹ã€‚'},'titan_worm':{no:2,name:'ã‚¿ã‚¤ã‚¿ãƒ³ãƒ¯ãƒ¼ãƒ ',race:'èŸ²æ—',habitat:'æ±šæŸ“ã•ã‚ŒãŸåœŸåœ°',story:'ãƒ¯ãƒ¼ãƒ ãŒå·¨å¤§åŒ–ã—ãŸäºœç¨®ã€‚å¼·é­ãªå¤–çš®ã‚’æŒã¡ã€ä¸¦å¤§æŠµã®æ”»æ’ƒã§ã¯å‚·ä¸€ã¤ã¤ã‹ãªã„ã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ã€‚'},'harpy':{no:3,name:'ãƒãƒ¼ãƒ”ã‚£',race:'é³¥äººæ—',habitat:'å±±å²³åœ°å¸¯',story:'å¥³æ€§ã®é¡”ã¨é³¥ã®ä½“ã‚’æŒã¤ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã€‚ãã®æ­Œå£°ã¯èˆ¹ä¹—ã‚Šã‚’æƒ‘ã‚ã›ã‚‹ã¨ã„ã†è¨€ã„ä¼ãˆãŒã‚ã‚‹ã€‚'},'goblin':{no:4,name:'ã‚´ãƒ–ãƒªãƒ³',race:'äºœäººæ—',habitat:'æ£®ã€æ´çªŸ',story:'çŸ¥èƒ½ã¯ä½ã„ãŒã€é›†å›£ã§è¡Œå‹•ã™ã‚‹å„ä»‹ãªãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã€‚æ‰‹è£½ã®æ£æ£’ã§è¥²ã„ã‹ã‹ã£ã¦ãã‚‹ã€‚'},'goblin_archer':{no:5,name:'ã‚´ãƒ–ãƒªãƒ³ã‚¢ãƒ¼ãƒãƒ£ãƒ¼',race:'äºœäººæ—',habitat:'æ£®',story:'å¼“çŸ¢ã®æ‰±ã„ã‚’è¦šãˆãŸã‚´ãƒ–ãƒªãƒ³ã€‚å¾Œæ–¹ã‹ã‚‰ã®æ”¯æ´å°„æ’ƒã¯ã€å˜ç´”ãªãŒã‚‰ã‚‚è„…å¨ã¨ãªã‚‹ã€‚'},'goblin_mage':{no:6,name:'ã‚´ãƒ–ãƒªãƒ³ãƒ¡ã‚¤ã‚¸',race:'äºœäººæ—',habitat:'å¤ä»£éºè·¡',story:'ã‚´ãƒ–ãƒªãƒ³ã®ä¸­ã§ã‚‚ç‰¹ã«çŸ¥èƒ½ã®é«˜ã„å€‹ä½“ã€‚åˆæ­©çš„ãªé­”æ³•ã‚’æ“ã‚Šã€ç«ã®ç‰ãªã©ã‚’æ”¾ã£ã¦ãã‚‹ã€‚'},'mega_goblin':{no:7,name:'ãƒ¡ã‚¬ã‚´ãƒ–ãƒªãƒ³',race:'äºœäººæ—',habitat:'ã‚´ãƒ–ãƒªãƒ³ã®å·£',story:'ã‚´ãƒ–ãƒªãƒ³ã®ç‹ã¨ã‚‚å‘¼ã°ã‚Œã‚‹å·¨å¤§ãªå€‹ä½“ã€‚ãã®æ€ªåŠ›ã¯å²©ã‚’ã‚‚ç •ãã¨æã‚Œã‚‰ã‚Œã¦ã„ã‚‹ã€‚'},'unknown008':{no:8,name:'ï¼Ÿï¼Ÿï¼Ÿ',race:'ï¼Ÿï¼Ÿï¼Ÿ',habitat:'ï¼Ÿï¼Ÿï¼Ÿ',story:'æœªç¢ºèªã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã€‚'},'unknown009':{no:9,name:'ï¼Ÿï¼Ÿï¼Ÿ',race:'ï¼Ÿï¼Ÿï¼Ÿ',habitat:'ï¼Ÿï¼Ÿï¼Ÿ',story:'æœªç¢ºèªã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã€‚'}},
    fields: {'hearts_plain':{name:'ãƒãƒ¼ãƒ„å¹³åŸ'},'misty_forest':{name:'éœ§ã®æ£®'}},
    blacksmithPurchaseConditions: [ { itemId: 'weapon001', condition: (gameData) => true }, { itemId: 'head001', condition: (gameData) => true }, { itemId: 'body001', condition: (gameData) => true }, { itemId: 'legs001', condition: (gameData) => true }, { itemId: 'weapon002', condition: (gameData) => gameData.party[0].level >= 5 }, { itemId: 'accessory001', condition: (gameData) => gameData.party[0].level >= 10 }, ],
    blacksmithCraftRecipes: [{itemId:'weapon002',materials:[{id:'material002',quantity:5},{id:'material001',quantity:10}],condition:(gameData)=>gameData.items.some(item=>item.id==='material002')}],
    generalStorePurchaseConditions: [{itemId:'item001',condition:(gameData)=>true},{itemId:'item002',condition:(gameData)=>gameData.party[0].class==='é­”å°å£«'||gameData.party[0].level>=3}],
};

// =================================================================================
// ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
// =================================================================================
let gameData;
let currentPurchase = { itemId: null, quantity: 1, price: 0 };
let currentSell = { itemId: null, quantity: 1, sellPrice: 0, maxQuantity: 0 };
let currentEquipmentChange = { memberIndex: null, slot: null };

// --- ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ã¨ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰ ---
window.onload = function() {
    loadGame();
    setupEventListeners();
    if (gameData) {
        renderAll();
        switchScreen('main-menu');
    }
};

function loadGame() {
    const savedData = localStorage.getItem('textRpgGameData');
    if (savedData) {
        gameData = JSON.parse(savedData);
    } else {
        document.getElementById('first-time-modal').style.display = 'flex';
    }
}

function saveGame() {
    if (gameData) {
        localStorage.setItem('textRpgGameData', JSON.stringify(gameData));
    }
}

function generateStats(playerClass) {
    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    let stats = { Li: rand(8, 12), St: rand(8, 12), In: rand(8, 12), Pa: rand(8, 12), Ag: rand(8, 12) };
    if (playerClass === 'å‰£å£«') {
        stats.St = rand(12, 16);
        stats.In = rand(3, 6);
    } else if (playerClass === 'é­”å°å£«') {
        stats.In = rand(12, 16);
        stats.St = rand(3, 6);
    }
    return stats;
}

function initNewGame(playerClass) {
    const playerName = document.getElementById('player-name-input').value.trim() || 'å†’é™ºè€…';
    const player = {
        name: playerName,
        class: playerClass,
        level: 1,
        exp: 0,
        nextExp: 100,
        baseStats: generateStats(playerClass),
        equipment: { weapon: null, head: null, body: null, legs: null, accessory1: null, accessory2: null },
    };
    gameData = {
        party: [player, null, null, null],
        gold: 200,
        items: [{ id: 'item001', quantity: 3 }, { id: 'weapon001', quantity: 1 }],
        unlockedFields: ['hearts_plain'],
        fieldProgress: { 'hearts_plain': { monsterCompletion: 0, itemCompletion: 0, mapCompletion: 0, overall: 0, rewardClaimed: false }, },
        monsterLog: {},
    };
    Object.keys(DB.monsters).forEach(id => {
        if (!id.startsWith('unknown')) gameData.monsterLog[id] = { discovered: true };
    });
    saveGame();
    document.getElementById('first-time-modal').style.display = 'none';
    renderAll();
    switchScreen('main-menu');
}

// --- UIæç”»é–¢é€£ ---
function renderAll() {
    if (!gameData) return;
    renderStatus();
    renderScreens();
}

function renderStatus() {
    const player = gameData.party[0];
    document.getElementById('player-name').textContent = player.name;
    document.getElementById('player-class').textContent = player.class;
    document.getElementById('player-level').textContent = player.level;
    document.getElementById('player-gold').textContent = gameData.gold;
}

function renderScreens() {
    renderGuild();
    renderBlacksmith();
    renderGeneralStore();
    renderExplore();
    renderPartyScreen();
    renderItemsScreen('equipment', document.querySelector('#items-screen button')); 
    renderMonsterBook();
    renderExportData();
}

function switchScreen(screenId) { /* ... (å¤‰æ›´ãªã—) ... */ }
function showTab(tabId, clickedButton) { /* ... (å¤‰æ›´ãªã—) ... */ }
function showConfirmation(title, message, onConfirm) { /* ... (å¤‰æ›´ãªã—) ... */ }

// --- é€šçŸ¥æ©Ÿèƒ½ ---
function showNotification(message, type = 'success') { /* ... (å¤‰æ›´ãªã—) ... */ }

// --- ã‚·ãƒ§ãƒƒãƒ—æ©Ÿèƒ½ (è³¼å…¥) ---
function openPurchaseModal(itemId) {
    const item = DB.items[itemId];
    if (!item) return;
    if (gameData.gold < item.price) {
        showNotification("ã‚´ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚", "error");
        return;
    }
    currentPurchase = { itemId, quantity: 1, price: item.price };
    document.getElementById('purchase-item-name').textContent = item.name;
    document.getElementById('purchase-item-desc').textContent = item.description;
    updatePurchaseModal();
    document.getElementById('purchase-modal').style.display = 'flex';
}

function updatePurchaseModal() {
    const input = document.getElementById('purchase-qty-input');
    currentPurchase.quantity = parseInt(input.value) || 1;
    if (currentPurchase.quantity < 1) currentPurchase.quantity = 1;
    if (currentPurchase.quantity > 99) currentPurchase.quantity = 99;
    input.value = currentPurchase.quantity;

    const totalCost = currentPurchase.price * currentPurchase.quantity;
    const costElement = document.getElementById('purchase-total-cost');
    const warningElement = document.getElementById('purchase-warning');
    
    costElement.textContent = totalCost;
    const isOverBudget = totalCost > gameData.gold;
    
    costElement.classList.toggle('text-red-500', isOverBudget);
    warningElement.textContent = isOverBudget ? 'ã‚´ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚' : '';
    
    document.getElementById('purchase-player-gold').textContent = gameData.gold;
    document.getElementById('purchase-confirm-btn').disabled = isOverBudget || totalCost <= 0;
}


function buyItem() {
    const totalCost = currentPurchase.price * currentPurchase.quantity;
    if (gameData.gold >= totalCost) {
        gameData.gold -= totalCost;
        addItemToInventory(currentPurchase.itemId, currentPurchase.quantity);
        saveGame();
        renderAll();
        showNotification(`${DB.items[currentPurchase.itemId].name} ã‚’ ${currentPurchase.quantity}å€‹ è³¼å…¥ã—ã¾ã—ãŸã€‚`, "success");
        document.getElementById('purchase-modal').style.display = 'none';
    } else {
        showNotification("ã‚´ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚", "error");
    }
}

// --- ã‚·ãƒ§ãƒƒãƒ—æ©Ÿèƒ½ (å£²å´) ---
function openSellModal(itemId) {
    const item = DB.items[itemId];
    const itemInInventory = gameData.items.find(i => i.id === itemId);
    if (!item || !itemInInventory) return;

    const equippedCount = getEquippedCount(itemId);
    const maxQuantity = itemInInventory.quantity - equippedCount;

    if (maxQuantity <= 0) {
        showNotification("è£…å‚™ä¸­ã®ãŸã‚å£²å´ã§ãã¾ã›ã‚“ã€‚", "error");
        return;
    }

    currentSell = { itemId, quantity: 1, sellPrice: item.sellPrice, maxQuantity: maxQuantity };
    document.getElementById('sell-item-name').textContent = item.name;
    document.getElementById('sell-qty-input').max = currentSell.maxQuantity;
    updateSellModal();
    document.getElementById('sell-modal').style.display = 'flex';
}

function updateSellModal() { /* ... (å¤‰æ›´ãªã—) ... */ }
function sellItem() { /* ... (å¤‰æ›´ãªã—) ... */ }

// --- ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªæ“ä½œ ---
function addItemToInventory(itemId, quantity) { /* ... (å¤‰æ›´ãªã—) ... */ }
function removeItemFromInventory(itemId, quantity) { /* ... (å¤‰æ›´ãªã—) ... */ }

function getEquippedCount(itemId) {
    let count = 0;
    gameData.party.forEach(member => {
        if (member) {
            Object.values(member.equipment).forEach(equippedId => {
                if (equippedId === itemId) {
                    count++;
                }
            });
        }
    });
    return count;
}

// --- è£…å‚™å¤‰æ›´æ©Ÿèƒ½ ---
function getSlotType(slot) { /* ... (å¤‰æ›´ãªã—) ... */ }

function openEquipmentModal(memberIndex, slot) {
    currentEquipmentChange = { memberIndex, slot };
    const member = gameData.party[memberIndex];
    const slotType = getSlotType(slot);
    const slotName = { weapon: 'æ­¦å™¨', head: 'é ­å…·', body: 'èƒ´å…·', legs: 'è„šå…·', accessory1: 'è£…é£¾å“1', accessory2: 'è£…é£¾å“2' }[slot];
    
    document.getElementById('equipment-slot-name').textContent = `${slotName}ã®å¤‰æ›´`;
    const listContainer = document.getElementById('equipment-list');
    listContainer.innerHTML = '';

    const availableItems = gameData.items.filter(item => DB.items[item.id]?.type === slotType);
    
    if (availableItems.length === 0) {
        listContainer.innerHTML = '<p class="text-gray-400">è£…å‚™ã§ãã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
    } else {
        availableItems.forEach(itemStack => {
            const item = DB.items[itemStack.id];
            const equippedCount = getEquippedCount(itemStack.id);
            
            const isCurrentlyEquippedBySelf = member.equipment[slot] === itemStack.id;
            const equippedByOthers = isCurrentlyEquippedBySelf ? equippedCount - 1 : equippedCount;
            const canEquip = itemStack.quantity > equippedByOthers;

            let equippedMark = '';
            if (equippedCount > 0) {
                equippedMark = `<sup class="text-green-400 font-bold ml-1">E</sup>`;
            }

            const element = document.createElement('div');
            element.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
            element.innerHTML = `
                <div>
                    <p class="font-semibold flex items-baseline">${item.name}${equippedMark}</p>
                    <p class="text-sm text-gray-400">${Object.entries(item.stats).map(([key, val]) => `${key.toUpperCase()}:+${val}`).join(', ')}</p>
                </div>
                <button class="rpg-button px-4 py-2 rounded" onclick="equipItem('${itemStack.id}')" ${!canEquip ? 'disabled' : ''}>è£…å‚™</button>
            `;
            listContainer.appendChild(element);
        });
    }

    if (member.equipment[slot]) {
        const unequipButton = document.createElement('button');
        unequipButton.className = 'rpg-button w-full mt-4 py-2 rounded bg-red-800 hover:bg-red-700';
        unequipButton.textContent = 'ã“ã®è£…å‚™ã‚’å¤–ã™';
        unequipButton.onclick = () => equipItem(null);
        listContainer.appendChild(unequipButton);
    }

    document.getElementById('equipment-modal').style.display = 'flex';
}

function equipItem(itemId) {
    const { memberIndex, slot } = currentEquipmentChange;
    const member = gameData.party[memberIndex];
    if (!member) return;

    if (itemId) {
        const itemInInventory = gameData.items.find(i => i.id === itemId);
        const equippedCount = getEquippedCount(itemId);
        const isCurrentlyEquippedBySelf = member.equipment[slot] === itemId;
        const equippedByOthers = isCurrentlyEquippedBySelf ? equippedCount - 1 : equippedCount;

        if (!itemInInventory || itemInInventory.quantity <= equippedByOthers) {
             showNotification("è£…å‚™ã§ãã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", "error");
             return;
        }
    }
    
    member.equipment[slot] = itemId;
    saveGame();
    renderAll();
    document.getElementById('equipment-modal').style.display = 'none';
}


// --- åå‰å¤‰æ›´æ©Ÿèƒ½ ---
function openNameChangeModal() {
    document.getElementById('name-change-input').value = gameData.party[0].name;
    document.getElementById('name-change-modal').style.display = 'flex';
}

function changeName() {
    const newName = document.getElementById('name-change-input').value.trim();
    if (newName) {
        gameData.party[0].name = newName;
        saveGame();
        renderAll();
        showNotification("åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚", "success");
        document.getElementById('name-change-modal').style.display = 'none';
    } else {
        showNotification("åå‰ã¯ç©ºã«ã§ãã¾ã›ã‚“ã€‚", "error");
    }
}

// --- å„ç”»é¢ã®æç”» ---
function renderShopList(containerId, conditionList) { /* ... (å¤‰æ›´ãªã—) ... */ }

function renderBlacksmith() {
    document.getElementById('blacksmith-gold').textContent = gameData.gold;
    renderShopList('blacksmith-purchase-list', DB.blacksmithPurchaseConditions);
    document.getElementById('blacksmith-craft-list').innerHTML = '';
}

function renderGeneralStore() {
    document.getElementById('general-store-gold').textContent = gameData.gold;
    renderShopList('store-purchase-list', DB.generalStorePurchaseConditions);
    renderSellList();
}

function renderSellList() {
    const container = document.getElementById('store-sell-list');
    container.innerHTML = '';
    
    const sellableItems = gameData.items.filter(itemStack => DB.items[itemStack.id]?.sellPrice > 0);

    if (sellableItems.length === 0) {
        container.innerHTML = '<p class="text-gray-400 col-span-full text-center">å£²å´ã§ãã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }

    sellableItems.forEach(itemStack => {
        const item = DB.items[itemStack.id];
        const equippedCount = getEquippedCount(itemStack.id);
        const sellableQuantity = itemStack.quantity - equippedCount;
        
        const element = document.createElement('div');
        element.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
        
        let equippedMark = '';
        if (equippedCount > 0) {
            equippedMark = `<sup class="text-green-400 font-bold ml-1">E</sup>`;
        }

        element.innerHTML = `
            <div>
                <p class="font-semibold flex items-baseline">${item.name}${equippedMark} <span class="text-gray-400 ml-2">(x${itemStack.quantity})</span></p>
                <p class="text-sm text-gray-400">å£²å€¤: ${item.sellPrice} G</p>
            </div>
            <button class="rpg-button px-4 py-2 rounded" onclick="openSellModal('${itemStack.id}')" ${sellableQuantity <= 0 ? 'disabled' : ''}>å£²å´</button>
        `;
        container.appendChild(element);
    });
}


function renderPartyScreen() { /* ... (å¤‰æ›´ãªã—) ... */ }
function renderPartyMemberDetails(index) { /* ... (å¤‰æ›´ãªã—) ... */ }

function renderItemsScreen(filterType, clickedButton = null) {
    if (clickedButton) {
        clickedButton.parentElement.querySelectorAll('button').forEach(btn => btn.classList.add('opacity-60'));
        clickedButton.classList.remove('opacity-60');
    }

    const container = document.getElementById('inventory-list');
    container.innerHTML = '';
    
    const equipmentTypes = ['weapon', 'head', 'body', 'legs', 'accessory'];
    let filteredItems;
    if (filterType === 'equipment') {
        filteredItems = gameData.items.filter(i => equipmentTypes.includes(DB.items[i.id].type));
    } else {
        filteredItems = gameData.items.filter(i => !equipmentTypes.includes(DB.items[i.id].type));
    }

    if (filteredItems.length === 0) {
        container.innerHTML = '<p class="text-gray-400 col-span-full text-center">è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }

    filteredItems.forEach(itemStack => {
        const item = DB.items[itemStack.id];
        const equippedCount = getEquippedCount(itemStack.id);
        let equippedMark = '';
        if (equippedCount > 0) {
            equippedMark = `<sup class="text-green-400 font-bold ml-1">E</sup>`;
        }

        const element = document.createElement('div');
        element.className = 'bg-gray-700 p-3 rounded';
        element.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-semibold flex items-baseline">${item.name}${equippedMark}</p>
                    <p class="text-sm text-gray-400">${item.description}</p>
                </div>
                <p class="text-lg font-bold">x${itemStack.quantity}</p>
            </div>
        `;
        container.appendChild(element);
    });
}

// --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
function setupEventListeners() {
    document.getElementById('select-swordsman').addEventListener('click', () => initNewGame('å‰£å£«'));
    document.getElementById('select-mage').addEventListener('click', () => initNewGame('é­”å°å£«'));
    document.getElementById('show-import-btn').addEventListener('click', () => {
        document.getElementById('new-game-selection').style.display = 'none';
        document.getElementById('import-game-section').style.display = 'block';
    });
    document.getElementById('back-to-new-game-btn').addEventListener('click', () => {
        document.getElementById('new-game-selection').style.display = 'block';
        document.getElementById('import-game-section').style.display = 'none';
    });
    document.getElementById('import-data-btn').addEventListener('click', importGame);
    document.querySelectorAll('button[data-screen]').forEach(button => {
        button.addEventListener('click', () => switchScreen(button.dataset.screen));
    });
    document.getElementById('copy-data-button').addEventListener('click', () => {
        const textarea = document.getElementById('export-data-textarea');
        textarea.select();
        document.execCommand('copy');
        showNotification("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚", "success");
    });
    document.getElementById('reset-data-btn').addEventListener('click', resetGameData);
    document.getElementById('purchase-qty-minus').addEventListener('click', () => { const i = document.getElementById('purchase-qty-input'); i.value = Math.max(1, parseInt(i.value) - 1); updatePurchaseModal(); });
    document.getElementById('purchase-qty-plus').addEventListener('click', () => { const i = document.getElementById('purchase-qty-input'); i.value = Math.min(99, parseInt(i.value) + 1); updatePurchaseModal(); });
    document.getElementById('purchase-qty-input').addEventListener('change', updatePurchaseModal);
    document.getElementById('purchase-cancel-btn').addEventListener('click', () => { document.getElementById('purchase-modal').style.display = 'none'; });
    document.getElementById('purchase-confirm-btn').addEventListener('click', buyItem);
    document.getElementById('equipment-cancel-btn').addEventListener('click', () => { document.getElementById('equipment-modal').style.display = 'none'; });
    document.getElementById('sell-qty-minus').addEventListener('click', () => { const i = document.getElementById('sell-qty-input'); i.value = Math.max(1, parseInt(i.value) - 1); updateSellModal(); });
    document.getElementById('sell-qty-plus').addEventListener('click', () => { const i = document.getElementById('sell-qty-input'); i.value = Math.min(currentSell.maxQuantity, parseInt(i.value) + 1); updateSellModal(); });
    document.getElementById('sell-qty-input').addEventListener('change', updateSellModal);
    document.getElementById('sell-cancel-btn').addEventListener('click', () => { document.getElementById('sell-modal').style.display = 'none'; });
    document.getElementById('sell-confirm-btn').addEventListener('click', sellItem);
    document.getElementById('name-change-btn').addEventListener('click', openNameChangeModal);
    document.getElementById('name-change-cancel-btn').addEventListener('click', () => { document.getElementById('name-change-modal').style.display = 'none'; });
    document.getElementById('name-change-confirm-btn').addEventListener('click', changeName);
}

// NOTE: çœç•¥ã—ãŸé–¢æ•°ç¾¤
generateStats=(playerClass)=>{const rand=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;let stats={Li:rand(8,12),St:rand(8,12),In:rand(8,12),Pa:rand(8,12),Ag:rand(8,12)};if(playerClass==='å‰£å£«'){stats.St=rand(12,16);stats.In=rand(3,6)}else if(playerClass==='é­”å°å£«'){stats.In=rand(12,16);stats.St=rand(3,6)}return stats};
switchScreen=(screenId)=>{document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active-screen'));document.getElementById(screenId+'-screen')?.classList.add('active-screen')};
showTab=(tabId,clickedButton)=>{const tabPrefix=tabId.substring(0,tabId.indexOf('-tab-'));clickedButton.parentElement.querySelectorAll('button').forEach(btn=>btn.classList.add('opacity-60'));clickedButton.classList.remove('opacity-60');let currentElement=clickedButton.parentElement.nextElementSibling;while(currentElement&&currentElement.classList.contains(`${tabPrefix}-tab`)){currentElement.style.display='none';currentElement=currentElement.nextElementSibling}
document.getElementById(tabId).style.display='block'};
showConfirmation=(title,message,onConfirm)=>{const modal=document.getElementById('confirmation-modal');document.getElementById('confirmation-title').textContent=title;document.getElementById('confirmation-message').textContent=message;modal.style.display='flex';const okBtn=document.getElementById('confirm-ok-btn');const cancelBtn=document.getElementById('confirm-cancel-btn');const cleanup=()=>{modal.style.display='none';okBtn.removeEventListener('click',okHandler);cancelBtn.removeEventListener('click',cancelHandler)};const okHandler=()=>{onConfirm();cleanup()};const cancelHandler=()=>cleanup();okBtn.addEventListener('click',okHandler,{once:true});cancelBtn.addEventListener('click',cancelHandler,{once:true})};
showNotification=(message,type='success')=>{const popup=document.getElementById('notification-popup');popup.textContent=message;popup.className=type;popup.classList.add('show');setTimeout(()=>{popup.classList.remove('show')},2500)};
updateSellModal=()=>{const input=document.getElementById('sell-qty-input');currentSell.quantity=parseInt(input.value)||1;if(currentSell.quantity<1)currentSell.quantity=1;if(currentSell.quantity>currentSell.maxQuantity)currentSell.quantity=currentSell.maxQuantity;input.value=currentSell.quantity;document.getElementById('sell-total-price').textContent=currentSell.sellPrice*currentSell.quantity};
sellItem=()=>{removeItemFromInventory(currentSell.itemId,currentSell.quantity);gameData.gold+=currentSell.sellPrice*currentSell.quantity;saveGame();renderAll();showNotification(`${DB.items[currentSell.itemId].name} ã‚’ ${currentSell.quantity}å€‹ å£²å´ã—ã¾ã—ãŸã€‚`,"success");document.getElementById('sell-modal').style.display='none'};
addItemToInventory=(itemId,quantity)=>{const existingItem=gameData.items.find(i=>i.id===itemId);if(existingItem){existingItem.quantity+=quantity}else{gameData.items.push({id:itemId,quantity:quantity})}};
removeItemFromInventory=(itemId,quantity)=>{const itemIndex=gameData.items.findIndex(i=>i.id===itemId);if(itemIndex>-1){gameData.items[itemIndex].quantity-=quantity;if(gameData.items[itemIndex].quantity<=0){gameData.items.splice(itemIndex,1)}}};
getSlotType=(slot)=>{if(slot.startsWith('accessory'))return'accessory';return slot};
renderShopList=(containerId,conditionList)=>{const container=document.getElementById(containerId);container.innerHTML='';conditionList.forEach(cond=>{if(cond.condition(gameData)){const item=DB.items[cond.itemId];const element=document.createElement('div');element.className='bg-gray-700 p-3 rounded flex justify-between items-center';element.innerHTML=`
<div><p class="font-semibold">${item.name}</p><p class="text-sm text-gray-400">${item.description}</p></div>
<button class="rpg-button px-4 py-2 rounded" onclick="openPurchaseModal('${cond.itemId}')">${item.price} G</button>`;container.appendChild(element)}})};
renderPartyScreen=()=>{const listContainer=document.getElementById('party-member-list');listContainer.innerHTML='';gameData.party.forEach((member,index)=>{const card=document.createElement('button');card.className='party-member-card rpg-button p-2 rounded w-full md:w-24 text-left';card.onclick=()=>renderPartyMemberDetails(index);if(member){card.innerHTML=`<p class="font-bold">${member.name}</p><p class="text-sm">${member.class} Lv.${member.level}</p>`}else{card.innerHTML='<p class="text-gray-400">ç©ºã</p>'}
listContainer.appendChild(card)});renderPartyMemberDetails(0)};
renderPartyMemberDetails=(index)=>{document.querySelectorAll('.party-member-card').forEach((card,i)=>card.classList.toggle('active',i===index));const detailsContainer=document.getElementById('party-member-details');const member=gameData.party[index];if(!member){detailsContainer.innerHTML='<p class="text-gray-400 text-center">ã“ã®ã‚¹ãƒ­ãƒƒãƒˆã«ãƒ¡ãƒ³ãƒãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚</p>';return}
const totalStats={...member.baseStats};Object.values(member.equipment).forEach(itemId=>{if(itemId&&DB.items[itemId]?.stats){Object.entries(DB.items[itemId].stats).forEach(([stat,value])=>{totalStats[stat]=(totalStats[stat]||0)+value})}});const statRow=(name,key)=>{const base=member.baseStats[key]||0;const equipBonus=totalStats[key]-base;return`<div class="grid grid-cols-3"><span>${name}</span><span class="text-right">${totalStats[key]}</span><span class="text-right text-green-400">${equipBonus>0?`(+${equipBonus})`:''}</span></div>`};const equipSlot=(name,key)=>{const itemId=member.equipment[key];const itemName=itemId?DB.items[itemId].name:'---';return`<button class="w-full text-left p-1 hover:bg-gray-700 rounded" onclick="openEquipmentModal(${index},'${key}')"><div class="flex justify-between"><span class="text-gray-400">${name}:</span> <span>${itemName}</span></div></button>`};detailsContainer.innerHTML=`
<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="text-xl font-bold mb-2">${member.name} - ${member.class} Lv.${member.level}</h3><div class="space-y-1 bg-gray-800 p-3 rounded">${statRow('ç”Ÿå‘½ (Li)','Li')}${statRow('ç­‹åŠ› (St)','St')}${statRow('çŸ¥æ€§ (In)','In')}${statRow('å¿è€ (Pa)','Pa')}${statRow('æ•æ· (Ag)','Ag')}</div></div>
<div><h3 class="text-xl font-bold mb-2">è£…å‚™</h3><div class="space-y-1 bg-gray-800 p-3 rounded">${equipSlot('æ­¦å™¨','weapon')}${equipSlot('é ­å…·','head')}${equipSlot('èƒ´å…·','body')}${equipSlot('è„šå…·','legs')}${equipSlot('è£…é£¾å“1','accessory1')}${equipSlot('è£…é£¾å“2','accessory2')}</div></div></div>`};
const importGame=()=>{const jsonString=document.getElementById('import-data-textarea').value;const errorSpan=document.getElementById('import-error');errorSpan.textContent='';try{const importedData=JSON.parse(jsonString);if(importedData&&importedData.party&&importedData.party[0].class){gameData=importedData;saveGame();document.getElementById('first-time-modal').style.display='none';renderAll();switchScreen('main-menu')}else{throw new Error('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™ã€‚')}}catch(e){errorSpan.textContent=e.message}};
const resetGameData=()=>{showConfirmation('æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ','ã™ã¹ã¦ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚',()=>{localStorage.removeItem('textRpgGameData');location.reload()})};
const originalRenderGuild=()=>{const container=document.getElementById('field-progress-container');container.innerHTML='';if(!gameData.unlockedFields)return;gameData.unlockedFields.forEach(fieldId=>{const fieldInfo=DB.fields[fieldId];const progress=gameData.fieldProgress[fieldId];if(!fieldInfo||!progress)return;progress.overall=Math.floor((progress.monsterCompletion+progress.itemCompletion+progress.mapCompletion)/3);const element=document.createElement('div');element.className='bg-gray-800 p-4 rounded';element.innerHTML=`
<h4 class="text-lg font-bold">${fieldInfo.name}</h4>
<div class="space-y-1 mt-2"><p>ç·åˆé”æˆåº¦: ${progress.overall}%</p><p class="text-sm text-gray-400">å›³é‘‘: ${progress.monsterCompletion}% | ã‚¢ã‚¤ãƒ†ãƒ : ${progress.itemCompletion}% | ãƒãƒƒãƒ—: ${progress.mapCompletion}%</p></div>
<button class="rpg-button px-4 py-1 mt-2 rounded ${progress.overall===100&&!progress.rewardClaimed?'':'opacity-50 cursor-not-allowed'}" ${progress.overall===100&&!progress.rewardClaimed?'':'disabled'}>${progress.rewardClaimed?'å ±é…¬å—å–æ¸ˆ':'100%å ±é…¬'}</button>`;container.appendChild(element)})};renderGuild=originalRenderGuild;
const originalRenderExplore=()=>{const container=document.getElementById('explore-field-list');container.innerHTML='';if(!gameData.unlockedFields)return;gameData.unlockedFields.forEach(fieldId=>{const fieldInfo=DB.fields[fieldId];if(!fieldInfo)return;const element=document.createElement('button');element.className='p-6 rounded rpg-button text-xl text-center';element.textContent=fieldInfo.name;container.appendChild(element)})};renderExplore=originalRenderExplore;
const originalRenderMonsterBook=()=>{const container=document.getElementById('monster-list');container.innerHTML='';Object.entries(DB.monsters).forEach(([id,monster])=>{const isDiscovered=gameData.monsterLog[id]?.discovered||false;const element=document.createElement('div');element.className=`p-4 rounded ${isDiscovered?'bg-gray-700':'bg-gray-800 border border-dashed border-gray-600'}`;if(isDiscovered){element.innerHTML=`
<h3 class="text-lg font-bold text-yellow-300">No.${monster.no} ${monster.name}</h3><p class="text-sm">ç¨®æ—: ${monster.race}</p><p class="text-sm">ç”Ÿæ¯åœ°: ${monster.habitat}</p><p class="mt-2 text-gray-300 text-sm italic">"${monster.story}"</p>`}else{element.innerHTML=`
<h3 class="text-lg font-bold text-gray-500">No.${monster.no} ï¼Ÿï¼Ÿï¼Ÿ</h3><p class="text-sm text-gray-500">ç¨®æ—: ï¼Ÿï¼Ÿï¼Ÿ</p><p class="text-sm text-gray-500">ç”Ÿæ¯åœ°: ï¼Ÿï¼Ÿï¼Ÿ</p>`}
container.appendChild(element)})};renderMonsterBook=originalRenderMonsterBook;
const originalRenderExportData=()=>{const textarea=document.getElementById('export-data-textarea');textarea.value=JSON.stringify(gameData,null,2)};renderExportData=originalRenderExportData;
</script>
</body>
</html>
